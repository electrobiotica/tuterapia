  // Estado global
    let modo = 'texto', ultimaRespuesta = '';
    let currentMood = 'üòä', sessionStartTime = Date.now();
    let selectedEmotion = 'üòä', emotionIntensity = 5;
    
    // Funci√≥n b√°sica de navegaci√≥n
  function irAEjercicios(ejercicioSugerido = null) {
    const terapiaActual = localStorage.getItem('terapiaPreferida') || 'humanista';
    let url = `/ejercicios?terapia=${terapiaActual}`;
    
    if (ejercicioSugerido) {
      url += `&ejercicio=${ejercicioSugerido}`;
    }
    
    window.location.href = url;
  }
  // ir a dashboard agregado por mi  

  function irADashboard() {
    window.location.href = '/dashboard';
  }

  // Sistema de progreso unificado
  function actualizarProgreso(actividad, datos = {}) {
    const progreso = JSON.parse(localStorage.getItem('progresoGeneral') || '{"actividades": [], "stats": {}}');
    
    const entrada = {
      tipo: actividad, // 'chat', 'respiracion', 'bitacora'
      timestamp: Date.now(),
      fecha: new Date().toDateString(),
      ...datos
    };
    
    progreso.actividades.unshift(entrada);
    
    // Mantener solo los √∫ltimos 100 registros
    if (progreso.actividades.length > 100) {
      progreso.actividades.splice(100);
    }
    
    // Actualizar estad√≠sticas
    if (!progreso.stats[actividad]) {
      progreso.stats[actividad] = { total: 0, tiempoTotal: 0, ultimaVez: null };
    }
    
    progreso.stats[actividad].total++;
    progreso.stats[actividad].ultimaVez = Date.now();
    
    if (datos.duracion) {
      progreso.stats[actividad].tiempoTotal += Math.round(datos.duracion / 60000) || 0;
    }
    
    localStorage.setItem('progresoGeneral', JSON.stringify(progreso));
    return progreso;
  }

  function obtenerEstadisticasGenerales() {
    const progreso = JSON.parse(localStorage.getItem('progresoGeneral') || '{"stats": {}}');
    return progreso.stats;
  }

  function calcularBienestarScore() {
    const stats = obtenerEstadisticasGenerales();
    let score = 5; // Base
    
    if (stats.chat?.total > 0) score += 1;
    if (stats.respiracion?.total > 0) score += 1.5;
    if (stats.bitacora?.total > 0) score += 1;
    
    const diasConsecutivos = calcularDiasConsecutivos();
    if (diasConsecutivos > 3) score += 0.5;
    if (diasConsecutivos > 7) score += 0.5;
    
    return Math.min(Math.round(score * 10) / 10, 10);
  }

  function calcularDiasConsecutivos() {
    const progreso = JSON.parse(localStorage.getItem('progresoGeneral') || '{"actividades": []}');
    const actividades = progreso.actividades;
    
    if (actividades.length === 0) return 0;
    
    let diasConsecutivos = 0;
    for (let i = 0; i < 30; i++) {
      const fecha = new Date();
      fecha.setDate(fecha.getDate() - i);
      const fechaStr = fecha.toDateString();
      
      const tieneActividad = actividades.some(act => act.fecha === fechaStr);
      if (tieneActividad) {
        diasConsecutivos++;
      } else if (i > 0) {
        break;
      }
    }
    return diasConsecutivos;
  }
  // Detectar emociones en el texto
  function detectarEmocionEnTexto(texto) {
    const palabrasEmocionales = {
      'üòî': ['triste', 'deprimido', 'melanc√≥lico', 'bajo', 'deca√≠do'],
      'üò∞': ['ansioso', 'nervioso', 'preocupado', 'angustiado', 'inquieto'],
      'üòä': ['bien', 'feliz', 'contento', 'tranquilo', 'relajado'],
      'ü§î': ['confuso', 'dudoso', 'pensativo', 'reflexivo'],
      'üí≠': ['perdido', 'enredado', 'bloqueado', 'sin claridad']
    };
    
    const textoLower = texto.toLowerCase();
    for (const [emoji, palabras] of Object.entries(palabrasEmocionales)) {
      if (palabras.some(palabra => textoLower.includes(palabra))) {
        return emoji;
      }
    }
    return null;
  }

  // Compartir estado emocional
  function compartirEstadoEmocional(mood, context) {
    const estado = {
      mood: mood,
      context: context,
      timestamp: Date.now(),
      origen: 'chat'
    };
    localStorage.setItem('estadoEmocionalActual', JSON.stringify(estado));
  }

  // Sugerir ejercicio basado en emoci√≥n
  function sugerirEjercicio(tipoEmocion, contexto = '') {
    const sugerencias = {
      'üòî': { ejercicio: '4-7-8', razon: 'perfecto para calmar la melancol√≠a' },
      'üò∞': { ejercicio: '4-7-8', razon: 'excelente para reducir la ansiedad' },
      'ü§î': { ejercicio: 'box', razon: 'ideal para encontrar claridad mental' },
      'üí≠': { ejercicio: 'coherent', razon: 'ayuda a organizar pensamientos' },
      'üòä': { ejercicio: 'coherent', razon: 'mantiene y profundiza la calma' }
    };
    
    return sugerencias[tipoEmocion] || { ejercicio: 'coherent', razon: 'ideal para bienestar general' };
  }

  // Mostrar tarjeta de sugerencia
  function mostrarSugerenciaEjercicio(tipoEmocion, contexto = '') {
    const sugerencia = sugerirEjercicio(tipoEmocion, contexto);
    
    const sugerenciaHTML = `
      <div class="suggestion-card" style="
        background: linear-gradient(135deg, rgba(79, 70, 229, 0.05), rgba(99, 102, 241, 0.05));
        border: 1px solid var(--primary-muted);
        border-radius: 20px;
        padding: 1.5rem;
        margin: 1rem 0;
        animation: slideInUp 0.5s ease-out;
      ">
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
          <span style="font-size: 2rem;">üßò</span>
          <div>
            <h4 style="color: var(--primary); font-weight: 600; margin: 0;">
              ¬øTe gustar√≠a hacer un ejercicio de respiraci√≥n?
            </h4>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin: 0.25rem 0 0 0;">
              ${sugerencia.razon}
            </p>
          </div>
        </div>
        <div style="display: flex; gap: 1rem; align-items: center;">
          <button onclick="irAEjercicios('${sugerencia.ejercicio}')" 
                  style="background: var(--primary); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 50px; font-weight: 500; cursor: pointer;">
            üåü Comenzar ${sugerencia.ejercicio}
          </button>
          <button onclick="this.closest('.suggestion-card').remove()" 
                  style="background: transparent; color: var(--text-muted); border: 1px solid var(--border-soft); padding: 0.75rem 1rem; border-radius: 50px; cursor: pointer;">
            Tal vez despu√©s
          </button>
        </div>
      </div>
    `;
    
    const chat = document.getElementById('chat');
    chat.insertAdjacentHTML('beforeend', sugerenciaHTML);
    setTimeout(() => chat.scrollTop = chat.scrollHeight, 100);
  }
  function mostrarEstadoSection() {
    mostrar('estadoSection');
// Helpers seguros (si no los ten√©s ya)
const $ = (id) => document.getElementById(id);
const setText = (id, val) => { const el = $(id); if (el) el.textContent = val; };

function mostrarEstadoSection() {
  // Si estoy en /chat y no existen los elementos del dashboard, redirijo
  const enChat = location.pathname.includes('/chat');
  const idsNecesarios = ['estado-actual','bienestarScore','streakDays','sesionesCompletadas','tiempoReflexion','ejerciciosRealizados'];
  const faltantes = idsNecesarios.filter(id => !$(id));

  if (enChat && faltantes.length) {
    // Evita el TypeError y lleva a la vista correcta
    location.href = '/dashboard#estado';
    return;
  }

  // Mostrar secci√≥n si existe en esta p√°gina (SPA)
  if ($('estadoSection') && typeof mostrar === 'function') {
    mostrar('estadoSection');
  }

  // Esperar a que DOM de la secci√≥n est√© visible
  setTimeout(() => {
    // Estado actual (todo null-safe)
    const estado = JSON.parse(localStorage.getItem('estadoEmocionalActual') || '{}');
    const mood = estado.mood || 'üå±';
    const contexto = estado.context || 'sin contexto registrado';
    setText('estado-actual', `Estado emocional actual: ${mood} ‚Äì ${contexto}`);

    // Stats
    const stats = obtenerEstadisticasGenerales();
    const bienestarScore = calcularBienestarScore();
    const diasConsecutivos = calcularDiasConsecutivos();

    setText('bienestarScore', `${bienestarScore}/10`);
    setText('streakDays', `${diasConsecutivos} d√≠as`);
    setText('sesionesCompletadas', ((stats.chat?.total || 0) + (stats.respiracion?.total || 0)));

    const minTot = (stats.chat?.tiempoTotal || 0) + (stats.respiracion?.tiempoTotal || 0); // minutos acumulados
    const horas = Math.floor(minTot / 60);
    const mins = minTot % 60;
    setText('tiempoReflexion', `${horas}h ${mins}min`);

    setText('ejerciciosRealizados', (stats.respiracion?.total || 0));
  }, 120); // un poquito m√°s de margen
}

    // Esperar un momento a que el DOM est√© visible si ven√≠s de otra secci√≥n
    setTimeout(() => {
      const estadoElement = document.getElementById("estado-actual");
      if (estadoElement) {
        const estado = JSON.parse(localStorage.getItem('estadoEmocionalActual') || '{}');
        const mood = estado.mood || 'üå±';
        const contexto = estado.context || 'sin contexto registrado';
        estadoElement.textContent = `Estado emocional actual: ${mood} ‚Äì ${contexto}`;
      } else {
        console.warn("‚ö†Ô∏è No se encontr√≥ #estado-actual en el DOM.");
      }
    }, 100);
    
    // Actualizar estad√≠sticas reales
    const stats = obtenerEstadisticasGenerales();
    const bienestarScore = calcularBienestarScore();
    const diasConsecutivos = calcularDiasConsecutivos();

    // Actualizar interfaz
    document.getElementById('bienestarScore').textContent = bienestarScore + '/10';
    document.getElementById('streakDays').textContent = diasConsecutivos + ' d√≠as';
    document.getElementById('sesionesCompletadas').textContent = (stats.chat?.total || 0) + (stats.respiracion?.total || 0);
    document.getElementById('tiempoReflexion').textContent = Math.round(((stats.chat?.tiempoTotal || 0) + (stats.respiracion?.tiempoTotal || 0)) / 60) + 'h ' + ((stats.chat?.tiempoTotal || 0) + (stats.respiracion?.tiempoTotal || 0)) % 60 + 'min';
    document.getElementById('ejerciciosRealizados').textContent = stats.respiracion?.total || 0;
  } 
    
    // Auto-resize textarea
    function autoResize(textarea) {
      textarea.style.height = 'auto';
      textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }

    // Timer de sesi√≥n
    function updateSessionTimer() {
      const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      document.getElementById('sessionTimer').textContent = 
        `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    setInterval(updateSessionTimer, 1000);

    // Navegaci√≥n
    function mostrar(id) {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelector(`[data-section="${id}"]`)?.classList.add('active');
    }

    // Estados de √°nimo
    function setMood(emoji, mood, event) {
      currentMood = emoji;
      document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      updateQuickResponses(mood);
    }
  const originalSetMood = setMood;
window.setMood = function(emoji, mood, ev) {
  originalSetMood(emoji, mood, ev);
  compartirEstadoEmocional(emoji, mood);
};
// Pas√° el evento expl√≠citamente en los handlers HTML: onclick="setMood('üòä','tranquilo', event)"
function escucharMicrofono(ev) {
  // ...
  const btn = ev?.target || document.activeElement;
  // ...
}

function guardarEntrada(ev) {
  // ...
  const btn = ev?.target;
  // ...
}
    function updateQuickResponses(mood) {
      const responses = {
        'tranquilo': [
          'Me siento en paz pero quiero profundizar',
          '¬øC√≥mo puedo mantener esta serenidad?',
          'Quiero explorar esta calma interior'
        ],
        'melanc√≥lico': [
          'Siento una tristeza que necesito comprender',
          'Todo parece m√°s pesado hoy',
          'Necesito acompa√±amiento en este momento'
        ],
        'inquieto': [
          'Mi mente no encuentra quietud',
          'Siento una energ√≠a nerviosa',
          'Necesito encontrar mi centro'
        ],
        'reflexivo': [
          'Estoy procesando algunas experiencias',
          'Quiero entender mejor lo que siento',
          'Necesito claridad sobre algo importante'
        ],
        'confuso': [
          'No logro entender qu√© me sucede',
          'Todo parece muy enredado',
          'Busco orientaci√≥n y claridad'
        ]
      };
      
      const container = document.getElementById('quickResponses');
      container.innerHTML = '';
      responses[mood]?.forEach(response => {
        const btn = document.createElement('button');
        btn.className = 'quick-response';
        btn.textContent = response;
        btn.onclick = () => sendQuickResponse(response);
        container.appendChild(btn);
      });
    }

    function sendQuickResponse(text) {
      document.getElementById('mensaje').value = text;
      enviarMensaje();
    }

    // Dark mode mejorado
    function toggleModo() {
      document.body.classList.toggle('dark-mode');
      const isDark = document.body.classList.contains('dark-mode');
      document.getElementById('themeIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      localStorage.setItem('darkMode', isDark);
    }

    // Cargar preferencias
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark-mode');
      document.getElementById('themeIcon').textContent = '‚òÄÔ∏è';
    }

    // TTS con configuraci√≥n suave
    function reproducirUltima() {
      if (!ultimaRespuesta) return;
      const utterance = new SpeechSynthesisUtterance(ultimaRespuesta);
      utterance.lang = 'es-AR';
      utterance.rate = 0.85;
      utterance.pitch = 1.05;
      utterance.volume = 0.8;
      speechSynthesis.speak(utterance);
    }

    // Typing indicator
    function typing(show) {
      document.getElementById('typing').classList.toggle('hidden', !show);
      if (show) {
        setTimeout(() => {
          document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
        }, 100);
      }
    }

    // Render mensaje con animaci√≥n suave
    function render(remitente, txt) {
      const container = document.createElement('div');
      container.className = `message-container ${remitente === 'Yo' ? 'message-user' : ''}`;
      
      if (remitente === 'Yo') {
        container.innerHTML = `
          <div class="bubble-me">${txt}</div>
          <div class="avatar avatar-user">${currentMood}</div>
        `;
      } else {
        container.innerHTML = `
          <div class="avatar avatar-bot">‚ú®</div>
          <div class="bubble-bot">${txt}</div>
        `;
      }
      
      document.getElementById('chat').appendChild(container);
      setTimeout(() => {
        document.getElementById('chat').scrollTop = document.getElementById('chat').scrollHeight;
      }, 100);
    }

    // Enviar mensaje con contexto emocional
    async function enviarMensaje() {
      const inp = document.getElementById('mensaje');
      const txt = inp.value.trim();
      if (!txt) return;
      // Detectar emoci√≥n en el texto
  const emocionDetectada = detectarEmocionEnTexto(txt);
  if (emocionDetectada && emocionDetectada !== currentMood) {
    currentMood = emocionDetectada;
    compartirEstadoEmocional(emocionDetectada, txt);
  }

      render('Yo', txt);
      inp.value = '';
      inp.style.height = 'auto';
      typing(true);

      try {
        await new Promise(r => {
          const w = () => window.puter?.ai?.chat ? r() : setTimeout(w, 50);
          w();
        });
        
        const context = `Eres un terapeuta humanista especializado, c√°lido y emp√°tico. El usuario se siente ${currentMood} actualmente. 

        Tu rol es:
        - Crear un espacio seguro y de aceptaci√≥n incondicional
        - Usar t√©cnicas de escucha activa y validaci√≥n emocional
        - Hacer preguntas abiertas que faciliten la autoexploraci√≥n
        - Responder con genuina calidez humana, no como una IA
        - Adaptar tu lenguaje al estado emocional del usuario
        - Ser conciso pero profundo, evitar respuestas muy largas
        - Usar un lenguaje naturalmente terap√©utico, sin jerga t√©cnica
        
        Responde de manera que el usuario sienta que est√° siendo verdaderamente escuchado y comprendido.`;
        
        const raw = await puter.ai.chat([
          {role: 'system', content: context},
          {role: 'user', content: txt}
        ], {model: 'gpt-4o'});
        
        const rsp = raw?.message?.content || 'Disculpa, en este momento no puedo procesar tu mensaje. ¬øPodr√≠as intentar de nuevo?';
        ultimaRespuesta = rsp;
        document.getElementById('btnLeer').classList.remove('hidden');
        
        typing(false);
        render('Bot', rsp);
        guardarConversacion(txt, rsp);
        // Analizar para sugerir ejercicios
  setTimeout(() => {
    analizarParaSugerirEjercicio(txt, rsp);
  }, 2000);
  // Actualizar progreso
  actualizarProgreso('chat', {
    mensajes: 1,
    duracion: Date.now() - sessionStartTime,
    mood: currentMood
  });
  // Analizar cu√°ndo sugerir ejercicios
  function analizarParaSugerirEjercicio(mensajeUsuario, respuestaBot) {
    const palabrasClave = [
      'ansioso', 'ansiedad', 'nervioso', 'preocupado',
      'estresado', 'estr√©s', 'tenso', 'agobiado',
      'no puedo dormir', 'insomnio', 'cansado',
      'confuso', 'bloqueado', 'sin claridad',
      'necesito calmarme', 'relajarme'
    ];
    
    const textoCompleto = (mensajeUsuario + ' ' + respuestaBot).toLowerCase();
    
    // Si el bot sugiere t√©cnicas de respiraci√≥n
    if (respuestaBot.toLowerCase().includes('respiraci√≥n') || 
        respuestaBot.toLowerCase().includes('respira') ||
        respuestaBot.toLowerCase().includes('calma')) {
      mostrarSugerenciaEjercicio(currentMood, mensajeUsuario);
      return;
    }
    
    // Si el usuario menciona palabras clave emocionales
    const palabraEncontrada = palabrasClave.find(palabra => textoCompleto.includes(palabra));
    if (palabraEncontrada) {
      setTimeout(() => {
        mostrarSugerenciaEjercicio(currentMood, palabraEncontrada);
      }, 3000);
    }
  }
        
      } catch (error) {
        typing(false);
        render('Bot', 'Ha ocurrido un inconveniente t√©cnico. Tu espacio sigue siendo seguro, por favor intenta nuevamente.');
        console.error('Error:', error);
      }
    }

    // STT mejorado
    function escucharMicrofono() {
      if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        alert('üéôÔ∏è Tu navegador no soporta reconocimiento de voz');
        return;
      }
      
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const recognition = new SpeechRecognition();
      recognition.lang = 'es-AR';
      recognition.continuous = false;
      recognition.interimResults = false;
      
      // Feedback visual
      const btn = event.target;
      btn.style.background = 'var(--primary)';
      btn.style.color = 'white';
      
      recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById('mensaje').value = transcript;
        autoResize(document.getElementById('mensaje'));
      };
      
      recognition.onend = () => {
        btn.style.background = '';
        btn.style.color = '';
      };
      
      recognition.onerror = (event) => {
        btn.style.background = '';
        btn.style.color = '';
        console.error('Error en reconocimiento de voz:', event.error);
      };
      
      recognition.start();
    }

    // LocalStorage con contexto emocional
    function guardarConversacion(q, r) {
      const log = JSON.parse(localStorage.getItem('chatAI') || '[]');
      log.push({
        q, r, 
        timestamp: Date.now(),
        mood: currentMood,
        sessionId: sessionStartTime
      });
      localStorage.setItem('chatAI', JSON.stringify(log));
    }

    // Bit√°cora emocional
    function selectEmotion(event) {
      const rect = event.currentTarget.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      const angle = Math.atan2(event.clientY - centerY, event.clientX - centerX);
      const normalizedAngle = (angle + Math.PI * 2) % (Math.PI * 2);
      const sector = Math.floor(normalizedAngle / (Math.PI / 4));
      
      const emotions = ['üòä', 'üå∏', '‚ú®', 'üå±', 'üíô', 'ü§î', 'üòî', 'üò∞'];
      selectedEmotion = emotions[sector];
      document.getElementById('selectedEmotion').textContent = selectedEmotion;
    }

    function updateIntensity(value) {
      emotionIntensity = value;
      document.getElementById('intensityValue').textContent = value;
    }

    function guardarEntrada() {
      const txt = document.getElementById('logInput').value.trim();
      if (!txt) return;
      
      const entrada = {
        fecha: new Date().toLocaleString('es-AR', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }),
        timestamp: Date.now(),
        texto: txt,
        emocion: selectedEmotion,
        intensidad: emotionIntensity,
        mood: currentMood
      };
      
      const bitacora = JSON.parse(localStorage.getItem('bitacoraAI') || '[]');
      bitacora.unshift(entrada);
      localStorage.setItem('bitacoraAI', JSON.stringify(bitacora));
      
      document.getElementById('logInput').value = '';
      cargarBitacora();
      // Actualizar progreso
  actualizarProgreso('bitacora', {
    palabras: txt.length,
    emocion: selectedEmotion,
    intensidad: emotionIntensity
  });
      
      // Feedback visual elegante
      const btn = event.target;
      const originalText = btn.textContent;
      btn.textContent = '‚ú® Guardado con amor';
      btn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
      setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
      }, 2000);
    }

    function cargarBitacora() {
      const datos = JSON.parse(localStorage.getItem('bitacoraAI') || '[]');
      const lista = document.getElementById('logList');
      
      if (datos.length === 0) {
        lista.innerHTML = `
          <div class="stats-card text-center" style="color: var(--text-secondary);">
            <div class="text-4xl mb-3">üìñ</div>
            <p>Tu diario emocional est√° esperando tus primeras reflexiones</p>
          </div>`;
        return;
      }
      
      lista.innerHTML = '';
      datos.forEach((entrada, index) => {
        const div = document.createElement('div');
        div.className = 'stats-card';
        div.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div class="flex items-center gap-3">
              <span class="text-2xl">${entrada.emocion || 'üå∏'}</span>
              <div>
                <div class="font-medium" style="color: var(--text-primary);">${entrada.fecha}</div>
                <div class="text-xs" style="color: var(--text-muted);">Intensidad emocional: ${entrada.intensidad || 5}/10</div>
              </div>
            </div>
            <button onclick="eliminarEntrada(${index})" 
                    class="text-red-400 hover:text-red-600 text-sm transition-colors p-1">üóëÔ∏è</button>
          </div>
          <p class="text-sm leading-relaxed whitespace-pre-wrap" style="color: var(--text-secondary);">${entrada.texto}</p>
        `;
        lista.appendChild(div);
      });
    }

    function eliminarEntrada(index) {
      if (!confirm('¬øEst√°s seguro de eliminar esta reflexi√≥n personal?')) return;
      
      const bitacora = JSON.parse(localStorage.getItem('bitacoraAI') || '[]');
      bitacora.splice(index, 1);
      localStorage.setItem('bitacoraAI', JSON.stringify(bitacora));
      cargarBitacora();
    }

    function exportBitacora() {
      const datos = JSON.parse(localStorage.getItem('bitacoraAI') || '[]');
      if (datos.length === 0) {
        alert('A√∫n no tienes reflexiones para exportar');
        return;
      }
      
      let contenido = `‚ú® Mi Diario de Bienestar Emocional\n`;
      contenido += `üìÖ Exportado el ${new Date().toLocaleDateString('es-AR')}\n`;
      contenido += `‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
      
      datos.forEach((entrada, index) => {
        contenido += `${entrada.emocion} ${entrada.fecha}\n`;
        contenido += `üí´ Intensidad emocional: ${entrada.intensidad}/10\n\n`;
        contenido += `${entrada.texto}\n\n`;
        if (index < datos.length - 1) contenido += `„Éª „Éª „Éª\n\n`;
      });
      
      contenido += `\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n`;
      contenido += `üíô Recuerda: cada reflexi√≥n es un paso hacia tu bienestar`;
      
      const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `mi-diario-emocional-${new Date().toISOString().split('T')[0]}.txt`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // Configuraci√≥n
    function cambiarTerapia(tipo) {
      const terapias = {
        'humanista': { emoji: 'üå±', nombre: 'Espacio de Crecimiento' },
        'gestalt': { emoji: 'üåÄ', nombre: 'Conciencia Presente' },
        'cognitivo': { emoji: 'üß©', nombre: 'Claridad Mental' },
        'mindfulness': { emoji: 'üßò', nombre: 'Atenci√≥n Plena' },
        'transpersonal': { emoji: '‚ú®', nombre: 'Conexi√≥n Profunda' }
      };
      
      const terapia = terapias[tipo];
      if (terapia) {
        document.getElementById('therapyEmoji').textContent = terapia.emoji;
        document.getElementById('tituloTerapia').textContent = terapia.nombre;
        localStorage.setItem('terapiaPreferida', tipo);
      }
    }

    function limpiarDatos() {
      if (!confirm('‚ö†Ô∏è Esta acci√≥n eliminar√° todas tus conversaciones, reflexiones y configuraciones. ¬øEst√°s completamente seguro?')) return;
      
      const confirmacion = prompt('Para confirmar, escribe "ELIMINAR TODO" (en may√∫sculas):');
      if (confirmacion !== 'ELIMINAR TODO') {
        alert('Operaci√≥n cancelada por seguridad.');
        return;
      }
      
      localStorage.removeItem('chatAI');
      localStorage.removeItem('bitacoraAI');
      localStorage.removeItem('terapiaPreferida');
      localStorage.removeItem('darkMode');
      localStorage.removeItem('mensajeTemporal');
      
      alert('‚úÖ Todos los datos han sido eliminados. La aplicaci√≥n se reiniciar√°.');
      location.reload();
    }

    // Ayuda contextual
    function showQuickHelp() {
      const helpModal = document.createElement('div');
      helpModal.className = 'fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50 p-6';
      helpModal.style.backdropFilter = 'blur(8px)';
      helpModal.innerHTML = `
        <div class="surface-elevated max-w-lg w-full p-8 max-h-96 overflow-y-auto">
          <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold" style="color: var(--text-primary);">üí° C√≥mo usar tu espacio de bienestar</h3>
            <button onclick="this.closest('.fixed').remove()" 
                    class="control-button text-lg">&times;</button>
          </div>
          <div class="space-y-4 text-sm leading-relaxed" style="color: var(--text-secondary);">
            <div class="flex gap-3">
              <span class="text-lg">üí¨</span>
              <div>
                <strong style="color: var(--text-primary);">Conversaci√≥n:</strong> 
                Expresa libremente tus sentimientos, el AI responder√° con calidez terap√©utica
              </div>
            </div>
            <div class="flex gap-3">
              <span class="text-lg">üòä</span>
              <div>
                <strong style="color: var(--text-primary);">Estados emocionales:</strong> 
                Selecciona c√≥mo te sientes para personalizar la experiencia
              </div>
            </div>
            <div class="flex gap-3">
              <span class="text-lg">üìñ</span>
              <div>
                <strong style="color: var(--text-primary);">Diario emocional:</strong> 
                Registra tus reflexiones diarias con la rueda de emociones
              </div>
            </div>
            <div class="flex gap-3">
              <span class="text-lg">üå∏</span>
              <div>
                <strong style="color: var(--text-primary);">Seguimiento:</strong> 
                Observa tu crecimiento emocional a trav√©s del tiempo
              </div>
            </div>
            <div class="flex gap-3">
              <span class="text-lg">üéôÔ∏è</span>
              <div>
                <strong style="color: var(--text-primary);">Modo voz:</strong> 
                Habla naturalmente y escucha las respuestas terap√©uticas
              </div>
            </div>
          </div>
          <div class="mt-6 p-4 rounded-2xl" style="background: rgba(79, 70, 229, 0.1); border: 1px solid rgba(79, 70, 229, 0.2);">
            <p class="text-xs leading-relaxed" style="color: var(--text-primary);">
              <strong>üíô Recordatorio importante:</strong> Esta aplicaci√≥n complementa, no reemplaza, la atenci√≥n profesional de salud mental. En situaciones de crisis, contacta servicios de emergencia o profesionales cualificados.
            </p>
          </div>
        </div>
      `;
      document.body.appendChild(helpModal);
    }

    // Inicializaci√≥n elegante
    document.addEventListener('DOMContentLoaded', function() {
      // Cargar configuraci√≥n
      const terapiaGuardada = localStorage.getItem('terapiaPreferida');
      if (terapiaGuardada) {
        cambiarTerapia(terapiaGuardada);
      }
      
      // Enter para enviar
      document.getElementById('mensaje').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          enviarMensaje();
        }
      });

      
      // Mensaje de bienvenida terap√©utico
      setTimeout(() => {
        if (document.getElementById('chat').children.length === 0) {
          render('Bot', `Hola, es un gusto acompa√±arte en este espacio. Veo que te sientes ${currentMood} en este momento. ¬øQu√© te gustar√≠a explorar juntos hoy?`);
        }
      }, 1500);
      
      // Configurar respuestas r√°pidas iniciales
      updateQuickResponses('tranquilo');
    });

    // Funcionalidades UX adicionales

    // Auto-save temporal
    let autoSaveTimeout;
    document.getElementById('mensaje').addEventListener('input', function() {
      clearTimeout(autoSaveTimeout);
      autoSaveTimeout = setTimeout(() => {
        if (this.value.trim()) {
          localStorage.setItem('mensajeTemporal', this.value);
        }
      }, 1000);
    });

    // Restaurar mensaje temporal
    window.addEventListener('load', function() {
      const mensajeTemporal = localStorage.getItem('mensajeTemporal');
      if (mensajeTemporal && mensajeTemporal.trim()) {
        document.getElementById('mensaje').value = mensajeTemporal;
        autoResize(document.getElementById('mensaje'));
        localStorage.removeItem('mensajeTemporal');
      }
    });

    // Detecci√≥n de inactividad con mensaje emp√°tico
    let inactivityTimer;
    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        if (document.getElementById('chatSection').classList.contains('active')) {
          const mensajesEmpaticos = [
            'T√≥mate el tiempo que necesites. Estar√© aqu√≠ cuando est√©s listo para continuar. üíô',
            'No hay prisa. Tu proceso es √∫nico y lo respeto completamente. ‚ú®',
            'Este espacio es tuyo. Si necesitas una pausa, est√° bien. Regresa cuando sientas que es el momento. üå∏'
          ];
          const mensaje = mensajesEmpaticos[Math.floor(Math.random() * mensajesEmpaticos.length)];
          render('Bot', mensaje);
        }
      }, 600000); // 10 minutos
    }

    document.addEventListener('click', resetInactivityTimer);
    document.addEventListener('keypress', resetInactivityTimer);
    resetInactivityTimer();